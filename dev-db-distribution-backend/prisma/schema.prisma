generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model Job {
  id          String      @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  ticket      String      @db.NVarChar(255)
  server      String      @db.NVarChar(255)
  database    String      @db.NVarChar(255)
  requestedBy String      @db.NVarChar(255)
  status      String      @default("PENDING") @db.NVarChar(50)
  blobPath    String?     @db.NVarChar(1024)
  etag        String?     @db.NVarChar(255)
  sha256      String?     @db.NVarChar(64)
  error       String?     @db.NVarChar(Max)
  createdAt   DateTime    @default(dbgenerated("sysutcdatetime()"))
  updatedAt   DateTime    @default(dbgenerated("sysutcdatetime()")) @updatedAt
  completedAt DateTime?
  downloads   Download[]

  @@index([status, createdAt])
  @@index([ticket])
}

model Download {
  id           String   @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  jobId        String   @db.UniqueIdentifier
  downloadedBy String   @db.NVarChar(255)
  ipAddress    String?  @db.NVarChar(64)
  userAgent    String?  @db.NVarChar(512)
  createdAt    DateTime @default(dbgenerated("sysutcdatetime()"))
  success      Boolean  @default(true)
  job          Job      @relation(fields: [jobId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([jobId, createdAt])
}

model Server {
  id        String     @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  name      String     @db.NVarChar(255)
  dns       String     @unique @db.NVarChar(255)
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(dbgenerated("sysutcdatetime()"))
  databases Database[]
}

model Database {
  id        String   @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  serverId  String   @db.UniqueIdentifier
  dbName    String   @db.NVarChar(255)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(dbgenerated("sysutcdatetime()"))
  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([serverId, dbName])
}
